■ ACL
확장(Extend) ACL
- 출발지/목적지 IP
  Protocol Type : IP, ICMP, EIGRP, OSPF, UDP, TCP
  출발지 및 목적지 Port Number
- 100 ~ 199번까지 사용 (2000 ~ 2699)

Named ACL
- 표준/확장 사용
- ACL 번호를 사용하는 대신 이름을 부여하여 사용

In/Outbound
- 트래픽을 식별할 때 특정 인터페이스로 들어오는 (Inbound) Data와
  특정 인터페이스로 나가는(Outbound) Data에 대해 개별적으로 식별





R3(config)#access-list 1 deny 192.168.11.0 0.0.0.255
			      [Network ID] [Subnetmask(deny) or Wildcardmask(permint)]
			[List1을 만들고, 
			 deny : 이에 대하여 통과하지 못하도록 만듬 (permit 입력시 허가)]
R3(config)#access-list 1 permit any
			[모든 네트워크에 대한 허용]

=> List 1에 대한 여러가지 정책이 있음
	Deny	: 192.168.11.0 0.0.0.255
	"Permit	: Any" (입력하지 않을 시 "deny any" (암묵적 거부, 모든 ACL에 기본적으로 제시되어있음))
	 ==> 항상 마지막에는 암묵적 거부가 들어가있으므로, 이를 방지하려면 Permit Any를 추가한다. (특정 네트워크만 차단할 목적이라면)


* 정책은 인터페이스별로 적용됨
ip access-group 1 in
    [ACL Creteria][in/out]
	ACL Creteria : 해당 번호를 가진 ACL 정책을 사용
	in : 해당 인터페이스로 들어오는 신호에 대한 조건 적용
	out : 해당 인터페이스로 나가는 신호에 대한 조건 적용

	
access-list 101 deny ip 192.168.10.0 0.0.0.255 host 209.165.200.255
		     [IP address]	       [host = wildcard mask 0.0.0.0]

wildcard mask
 => 1 bit	Host ID (Non Check)	>> 255.255.255.255 -> Any로 씀
 => 0 bit	Net ID (Check)		>> 0.0.0.0 -> Host로 씀


ex)
src	192.168.10 .00000001
	192.168.10 .00000010
deny	192.168.10 .00000000
	0  .0  .0  .11111110

=> 192.168.10.2 / 4 / 6 / 8 / 10 등은 모두 매치되어 패스됨 (짝수)

ex2)
premit 192.168.0.0 / 0.0.96.128


	192.168.0 00 00000 .0 0000000
	0  .0  .0 XX 00000 .X 0000000
	0  .0  .0 11 00000 .1 0000000

	192.168.0 00 00000 .0 0000000	=> 0.0
	192.168.0 00 00000 .1 0000000	=> 0.128
	192.168.0 01 00000 .0 0000000	=> 16.0
	192.168.0 01 00000 .1 0000000	=> 16.128
	192.168.0 10 00000 .0 0000000	=> 64.0 
	192.168.0 10 00000 .1 0000000	=> 64.128
	192.168.0 11 00000 .0 0000000	=> 96.0
	192.168.0 11 00000 .1 0000000	=> 96.128

--------------------------------------------------------------------
access-list 101 deny ip 192.168.10.0 0.0.0.255 host 209.165.200.255
access-list 101 permit ip any any
interface serial 0/0
ip access-group 101 out
end
--------------------------------------------------------------------

Example-PT)
조건 생성은 순차적으로 -> 순차적 적용으로서, 조건간 겹치는 부분으로 인한 오류 발생을 방지

각 Src에 따른 Packet 거부
ping packet - ICMP
http packet - tcp(http) : 80
	    - udp : 


	■ TCP / UDP
					TCP		UDP
		신뢰성			높음		낮음
		속도			느리다		빠르다
		Over Header		높음		낮음
		(CPU, Memory 등)



		Layer 7		http, FTP, SMTP(Email), POP3, Imap
				 80  20,21     25        25    25
				DNS, DHCP(Dynapic IP), NTP(Network Time Protocol)
	                	 53

	■ IEEE (Port Num)
		Battle.net, Cisco 등 큰 기업의 SW를 위한 Port Number도 있음.
		* 회사에서 자꾸 블리자드 게임 하는 놈 있으면 블리자드 포트 막아버리면 됨.


		포트 번호 - 잘 알려진 번호 (0 ~ 1023) : 공공의 목적
			  - 상업용 번호 (1024 ~ 49151) : 상업용, 배틀넷 등... 카카오톡 등 메신져도 포함되어있을 가능성 있음
							 (Server는 포트번호가 고정되어있으야하므로)
			  - 랜덤 번호 (Client, 49152 ~ 65535) : 굳이 정해서 사용할 필요는 없으나, 여러 상황에 따라 Client가 "고정된 포트번호를 가진 서버"와 통신을 할 필요가 있음.

Criterion 1. access-list 110 deny icmp host 192.168.10.10 host 192.168.20.254
Criterion 2. access-list 110 deny tcp host 192.168.11.10 host 192.168.20.254 eq 80	// eq 80 (Equal 80) 80과 같으면 차단	| neq 80 (Not Equal 80) 80과 같지 않으면 차단
											// lt (List 작다)			| gt (Great 크다)
Criterion 3. access-list 110 deny icmp host 192.168.30.10 host 192.168.20.254
Criterion 4. access-list 110 deny tcp host 192.168.30.10 host 192.168.20.254 eq 80	
Criterion 5. access-list 110 permit ip any any

in fa0/0
ip access-group 110 out

// 왜 eq 80을 붙여야 하는가?	http -> tcp : 80
				https(Secure) -> tcp : 443, UDP


=============================================================================================================================================================================================
■ NAT (Network Address Translate)
- IP Header의 주소를 다른 주소로 변환하는 기술
- 사설 IP 주소를 공인 IP 주소로 변환

■ 사설 IP 주소 범위
A Class : 10 .0  .0  .0   ~ 10 .255.255.255
B Class : 172.16 .0  .0   ~ 172.31 .255.255
C Class : 192.168.0  .0   ~ 192.168.255.255

■ Dynamic(동적) NAT
 - N개의 공인 IP주소를 M개의 사설 IP 주소로 연결(맵핑)
   (N : M 맵핑)
 - NAT-PAT(Port-Address) : 1개의 공인 IP 주소를 여러개의 사설 IP와 맵핑


■ Static (정적) NAT
 - 1개의 공인 IP 주소를 가지고 1개의 사설 IP 주소로 변환
   (1 : 1 맵핑)
 - Port-Forwarding -> 1개의 공인 IP 주소를 여러개의 사설 IP와 맵핑

■ NAT Table

사설 IP 주소 : 192.168.100.0/24
공인 IP 주소 : 200.200.200.0/29		1 ~ 6

NAT Table (Dynamic)
Inside Global		Inside Local		Outside Global		Outside Local	// 내부 : 내부에서 우리가 사용	| 외부 : 외부에서 사용, 
(내부 / 공인)		(내부 / 사설)		(외부 / 공인)		(외부 / 사설)	// 공인 : 공인 IP 주소		| 사설 : 사설 IP 주소
200.200.200.1		192.168.100.10		8.8.8.8			8.8.8.8		// Dynamic NAT에서 통신이 시도되었을 경우
200.200.200.2		192.168.100.20		8.8.8.8			8.8.8.8
200.200.200.3		192.168.100.30		8.8.8.8			8.8.8.8
200.200.200.4		192.168.100.40		8.8.8.8			8.8.8.8
200.200.200.5		192.168.100.50		8.8.8.8			8.8.8.8
200.200.200.6		192.168.100.60		8.8.8.8			8.8.8.8
			192.168.100.70		8.8.8.8			8.8.8.8

* 만약, 200.200.200.7이 추가 되려한다면, 더이상 사용할 수 있는 공인 IP 주소가 없으므로, 통신이 불가함.
  (그러므로, 192.168.100.70이 통신을 할 수 있는 경우는 위의 예치된 공인 IP 주소를 가진 기기 중 1대가 더이상 통신을 할 수 있는 상태가 아닐 때, Dynamic NAT의 기능에 따라 자동으로 추가됨)
* Dynamic NAT의 한계점 : 내부 공인 IP 주소의 개수에 따라 예치의 한계가 있음.
  이를 보완하기 위한 NAT-PAT

NAT-PAT Table (Dynamic)
Inside Global		Inside Local		Outside Global		Outside Local
(내부 / 공인)		(내부 / 사설)		(외부 / 공인)		(외부 / 사설)
200.200.200.1:10000	192.168.100.10:10000	8.8.8.8			8.8.8.8		
200.200.200.1:20000	192.168.100.20:20000	8.8.8.8			8.8.8.8		
200.200.200.1:30000	192.168.100.30:30000	8.8.8.8			8.8.8.8	

* 하나의 공인 IP 주소만으로도, 여러 Device들이 통신을 하는 것이 가능 (이론적으로!)
  여러개의 Port를 통하여 외부와 통신을 하는 특성으로 인하여, 예치의 수가 역시 한정된다.
* Random으로 받은 Port 번호가 다른 Port와 겹치게 설정하는 것은 불가함.



NAT-PAT Table (Static)
Inside Global		Inside Local		Outside Global		Outside Local
(내부 / 공인)		(내부 / 사설)		(외부 / 공인)		(외부 / 사설)
200.200.200.1		192.168.100.10
200.200.200.2:80	192.168.100.40:80
200.200.200.2:81	192.168.100.50:80
200.200.200.2:82	192.168.100.60:80

 * Static의 경우, Oustside에 대한 정보는 작성되지 않으며, 
   200.2번의 경우와 같이, 각 포트를 다른 IP에 지정해줄 수 있음,

===========================================================================================================================
■ Dynamic NAT 설정

en
conf t	// 전역설정모드에서 입력

!- 공인 IP 주소 범위 설정
ip nat pool [Name] [Start IP Addr.] [End IP Addr.] netmask [Mask Addr.]

!- 사설 IP 주소 식별
access-list [1~99] permit [Start IP Addr.] [Wildcard]

!- 변환을 위한 설정
ip nat inside source list [1~99] pool [Name] <Overload>	// Name : 아까 설정한 NAT Name | Overload : PAT 옵션 설정 (PAT Enable)

!- 내부 외부 설정 (인터페이스 별로 적용)
<내부>
ip nat inside

<외부>
ip nat outside

■ Static NAT 설정

ip nat inside source static [사설 IP Addr.] [공인 IP Addr.]

!- 전역설정모드에서 입력 (정적 NAT - Port Forwarding)
ip nat inside source static [tcp|udp] [사설 IP 주소] [Port Num.] [공인 IP 주소] [Port Num.]

!- 내부 외부 설정 (인터페이스 별로 적용)
<내부>
ip nat inside

<외부>
ip nat outside

■ NAT Table 보기
show ip nat translation	// 관리자모드에서 입력


===========================================================================================================================
■ Dynamic NAT
do show hist	// 최근 10개 Command 조회
<Router0>
host R0
in fa0/0
ip add 192.168.100.254 255.255.255.0
no sh
in fa0/1
ip add 120.0.0.1 255.255.255.252
no sh
ex
ip route 0.0.0.0 0.0.0.0 120.0.0.2

<Router1>
en
conf t
host R1
in fa0/0
ip add 120.0.0.2 255.255.255.252
no sh
in lo0
ip add 8.8.8.8 255.255.255.0
do show hi

///////////////////////////// 여기까지 하면, 사설 IP 주소에 대한 정책적인 차단으로 인해 통신이 불가함.
			      공인 IP 주소를 받았으므로, 공인 IP를 사용한다.

!- 사설 IP 전체 설정
ip nat pool publicIP 200.200.200.1 200.200.200.6 netmask 255.255.255.248
	    [Name]   [Start IP]    [End IP]		 [/29]
access-list 10 permit 192.168.100.0 0.0.0.127
				    [01111111, 0 ~ 127까지만 변환 허용, 128부터는 변환 안시켜줌]

!- 변환을 허가시켜줄 사설 IP의 범위 설정
ip nat inside source list 10 pool publicIP overload]	// ① - [Access list Num]
			  ①      [Name]
int se0/0
ip nat inside
int se0/1
ip nat outside

do show ip nat translation	// 확인 가능

=> 192.168.100.128부터는, G/W까지의 통신은 가능하나, 외부로의 통신이 불가함.

■ Static NAT
ip nat inside source static ?
ip nat inside source static 192.168.100.128 ?
ip nat inside source static 192.168.100.128 200.200.200.2
do show ip nat translation	// Static 추가된 것을 확인 가능

외부에서부터 시작한 Traffic이 들어올 경우에는, Table에 Mapping된 정보가 있는 경우에만 통신이 가능 (보안성이 향상될 수 있음)
내부에서 시작한 Traffic의 경우, Table에 실시간 Mapping이 되므로, 나갈 수 있음.




















